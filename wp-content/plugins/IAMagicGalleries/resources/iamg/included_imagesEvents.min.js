/*
 * Copyright Â© 2023 Information Aesthetics. All rights reserved.
 * This work is licensed under the GPL2, V2 license.
 */

!function(){const e=!0;let t,n;e&&console.log("In included images events");let i,a,o,l,r=!1,s={id:void 0,selected:void 0};function c(){t&&"none"===t.attr("display")&&(t.attr({opacity:0,display:""}),t.animate({opacity:1},500)),r=!0}function d(){t&&"none"!==t.attr("display")&&t.animate({opacity:0},500,()=>t.attr("display","none")),r=!1}IA_Designer.addButtonFunction("included_imagesToggle",function(){r?d():c()}),IA_Designer.addButtonFunction("included_images_init",function(a,r,g){(t=(i=this).controllerWidgets.controllerPanel({id:r,controllers:a,use_scrollbox:!1,change_event:g.changeEvent})).attr({display:"none"}),t.addEveListener(["controller","included_images","open"],c),t.addEveListener(["controller","included_images","close"],d),t.addEveListener(g.changeEvent,function(){const e=t.panel_state.selected_images;e&&e.length?(i.eve(["gui","button","clear_included_images","activate"]),o&&i.eve(["gui","button","iamg_create_gallery","activate"])):(i.eve(["gui","button","clear_included_images","deactivate"]),i.eve(["gui","button","iamg_create_gallery","deactivate"])),n&&"text"===n.type&&(n.node.innerHTML=e.length||0)}),t.addEveListener(["iamg","included_images","remove_image"],function(n){e&&console.log("To remove",n),t.externalUpdate({selected_images:[n,-1]})}),i.controllers.included_images=t,n=i.defs.select("#iamg_num_pictures"),function(){const e=i.div_container.getId();let t=setInterval(function(){document.getElementById(e)||(clearInterval(t),i.eve("global.iamg.gallery.removed",i),i.svgRoot.remove(),i=void 0)},1e3)}(),t.addEveListener(["iamg","set_gallery_type","*"],function(){let n=i;if(!n&&this&&this.eve&&(n=this),!n)return;const a=n.eve.nts();if(o===a[2])return;const r=s.id;o=a[2],l=a[3];let c=a[4];if(s.id&&s.id!==c&&n.eve(["library",r,"close"]),c&&n.eve(["library",c,"open"]),s.id=c,s.selected=void 0,"none"===o)return o=void 0,void n.eve(["gui","button","iamg_create_gallery","deactivate"]);t.panel_state.selected_images&&t.panel_state.selected_images.length?n.eve(["gui","button","iamg_create_gallery","activate"]):n.eve(["library","iamg_image_library","open"]),e&&console.log(o,l,s)}),t.addEveListener("library.*.apply",function(e){let t=this;s.id===t.id&&t.targetGet&&(s.selected=t.targetGet(e))}),function(t){let n=i.defs.g({id:"included-images-temp-location"});t.addEveListener(["iamg","load_gallery_setup"],function(a,o,l,r){e&&console.log(o);for(var s=0;s<o.length;s++){const e=o[s].id,i=o[s].url;let a=n.image(i,0,0,150,150,{id:e});t.externalUpdate({selected_images:[a,s]})}if(i.eve(["controller","included_images","open"]),l){i.eve(["widget","panel","update",a+"_panel"],void 0,l);const t=i.eve(["widget","panel","getPanel",a+"_panel"])[0];e&&console.log("Updated panel",a+"_panel",t.panel_state,"passed",l)}i.eve("presenter.linkFollow",void 0,a)})}(t)});function g(t){if(e&&console.log(t),!t||!t.svg||!t.locator)return i.eve(["gui","button","iamg_create_gallery","activate"]),void i.eve(["gui","error"],"Gallery could not be created by the server!");const n=atob(t.svg);a=t.locator;for(let e in i.libraries)i.libraries.hasOwnProperty(e)&&i.eve("library."+i.libraries[e].id+".close");i.eve(["controller","included_images","close"]),i.eve("gui.button.get_by_class",void 0,"iamg-button").firstDefined().forEach(e=>i.eve("gui.button."+e.name+".hide")),i.eve("gui.button.get_by_class",void 0,"iamg-preview-button").firstDefined().forEach(e=>i.eve("gui.button."+e.name+".activate")),i.eve("presenter.backupPresentation",void 0,"selector_presentation"),i.loadGraphicsFromString(n,"preview_gallery")}let u;IA_Designer.addButtonFunction("included_images_clear",function(){e&&console.log(t);const n=t.panel_state.selected_images;n&&n.length&&n.forEach(e=>{t.externalUpdate({selected_images:[e,-1]})})}),IA_Designer.addButtonFunction("iamg_go_home",function(){i.eve(["presenter","linkFollow"],"home"),i.eve(["gui","button","iamg_create_gallery","deactivate"])}),IA_Designer.addButtonFunction("iamg_create_gallery",function(){i.eve(["gui","button","iamg_create_gallery","deactivate"]),e&&console.log("Creating gallery based on",o,l,s);let n=t.panel_state.selected_images;if(!n||!n.length)return void i.eve("gui.error","There are no images selected!");n=n.map(e=>({id:(e=e.split("_")).pop(),title:e.join("_")}));const a={gallery_type:o,images:n},r={};if(l){const e=i.eve("widget.panel.getPanel."+l).firstDefined();e&&e.panel_state&&Object.assign(r,e.panel_state),a.settings=r}s.selected&&(a.resource=s.selected.getId());const c=Object.assign({command:"make_gallery"},a);i.comManager.sendCommand(void 0,c,"json",g,void 0,t=>{e&&console.log("Error,",t),i.eve(["gui","button","iamg_create_gallery","activate"])})}),IA_Designer.addButtonFunction("iamg_back_to_setup",function(){i.eve("gui.button.get_by_class",void 0,"iamg-button").firstDefined().forEach(e=>i.eve("gui.button."+e.name+".show")),i.eve("gui.button.get_by_class",void 0,"iamg-preview-button").firstDefined().forEach(e=>i.eve("gui.button."+e.name+".deactivate")),i.eve("presenter.restorePresentation",void 0,"selector_presentation"),i.eve(["gui","button","iamg_create_gallery","activate"])}),IA_Designer.addButtonFunction("iamg_save_gallery",function(){a&&(e&&console.log("saving gallery"),i.eve("global.iamg.gallery.save",i,a))});const v="iamg_behave_icon",_="fixed";function m(e){u.forEach(t=>{t.getId()===e?t.attr("display",""):t.attr("display","none")})}let p;IA_Designer.addButtonFunction("behaviour_settings_init",function(e,t,n){if(i=this,!u){const e=i.defs.select("#"+v);u=e.getChildren(),m(_)}(p=i.controllerWidgets.controllerPanel({id:t,controllers:e,use_scrollbox:!1,change_event:n.changeEvent,background:n.background})).attr({display:"none"}),p.addEveListener(["controller","behaviour_settings","open"],()=>{p&&"none"===p.attr("display")&&(p.attr({opacity:0,display:""}),p.animate({opacity:1},500)),r=!0}),p.addEveListener(["controller","behaviour_settings","close"],()=>{p&&"none"!==p.attr("display")&&p.animate({opacity:0},500,()=>p.attr("display","none")),r=!1}),i.controllers.behaviour_settings=p}),IA_Designer.addButtonFunction("behave_setting_toggle",function(){"none"===p.attr("display")?i.eve(["controller","behaviour_settings","open"]):i.eve(["controller","behaviour_settings","close"])})}();